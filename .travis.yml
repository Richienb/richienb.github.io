# Disable sudo to speed up build
sudo:                             false

# Set build language to Node JS
language:                         node_js

# Set the version of Node JS to use
node_js:                          node

# Set build branch
branches:                         master

before_install:
    # Configure access token to enable pushing to the repository
    - git remote set-url origin https://Richienb:${github_token}@github.com/Richienb/richienb.github.io.git

    # Set commit username
    - git config --global user.name "ROS Bot"

    # Set commit email
    - git config --global user.email "richiebendall@gmail.com"

jobs:
    include:
        - stage:                  Optimisation & Generating # Generate final compiled files

          cache:
              # Ensure npm is cached
              directories:
                  - node_modules # NPM packages

          install:
              # Navigate to the source directory
              - cd src

              # Install the yarn package manager
              - npm install -g yarn

              # Install required packages
              - yarn install --non-interactive --production

          before_deploy:
              # Build the website
              - npm run build

          deploy:
              provider:           pages
              skip-cleanup:       true
              local-dir:          dist
              github-token:       $github_token
              keep-history:       true
              fqdn:               www.richie-bendall.ml
              committer-from-gh:  true
              on:
                  branch:         master

          after_deploy:
              # Clear CloudFlare cache
              - |
                curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${cf_zone_id}/purge_cache" \
                -H "X-Auth-Email: richiebendall@gmail.com" \
                -H "X-Auth-Key:   ${cf_api_key}" \
                -H "Content-Type: application/json" \
                --data '{"purge_everything":true}'

notifications:
    # Disable emails for build status notifications
    email:                        false
