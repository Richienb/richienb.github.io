# Disable sudo to speed up build
sudo:                   false

# Set build language to Node JS
language: node_js

# Set the version of Node JS to use
node_js: "node"

# Set build branch
branches:               master

before_install:
  # Configure access token to enable pushing to the repository
  - git remote set-url origin https://Richienb:${github_token}@github.com/Richienb/richienb.github.io.git

  # Set commit username
  - git config --global user.name "ROS Bot"

  # Set commit email
  - git config --global user.email "richiebendall@gmail.com"
  
  # Make all the shell files in the ci folder executable
  - find $TRAVIS_BUILD_DIR/ci -type f -iname "*.sh" -exec chmod +x {} \;

jobs:
  include:
    - stage: temp
    
      cache:
      # Ensure npm is cached
          directories:
              - node_modules # NPM packages
    
      script:
        - npm init -y
        
      after_script:
        - git add . && ./ci/commitpush.sh "CI | Add Config [skip ci]"
    
    - stage:            Optimisation & Generating

      cache:
        # Ensure pip is cached
        - pip

      # Set the build language
      language:         python

      # Set the build language version
      python:           3.6.6

      install:
        # Install the required dependency
        - pip install pyspelling

      script:
        # Check for spelling errors
        - pyspelling

    - # Generate service worker

      cache:
          # Ensure npm is cached
          directories:
            - node_modules # NPM packages

      install:
        # Install the service worker generator
        - npm install workbox-cli --global
        # Install GULP
        - npm install gulp -D
        - npm install gulp-cli -g

      script:
        # Generate service worker cacher
        - npm run-script sw

      after_script:
        # Commit and push
        - git add . && ./ci/commitpush.sh "CI | Update service worker caching configuration [skip ci]"

        # Clear CloudFlare cache
        - |
          curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${cf_zone_id}/purge_cache" \
          -H "X-Auth-Email: richiebendall@gmail.com" \
          -H "X-Auth-Key: ${cf_api_key}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'

notifications:
  # Disable emails for build status notifications
  email:                false
