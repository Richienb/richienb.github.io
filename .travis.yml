# Disable sudo to speed up build
sudo:                   false

# Set build language to Node JS
language:               node_js

# Set the version of Node JS to use
node_js:                node

cache:
    # Ensure npm is cached
    directories:
        - node_modules # NPM packages

before_install:
    # Configure access token to enable pushing to the repository
    - git remote set-url origin https://Richienb:${github_token}@github.com/Richienb/richienb.github.io.git

    # Set commit username
    - git config --global user.name "ROS Bot"

    # Set commit email
    - git config --global user.email "richiebendall@gmail.com"

install:
    # Navigate to the source directory
    - cd src

    # Install the yarn package manager
    - npm install -g yarn

    # Install required packages
    - yarn install --non-interactive --production

script:
    # Build the website with Webpack
    - npm run build

    # Generate the service worker
    - npx workbox injectManifest workbox-config.js

    # Remove the unneeded node_modules folder
    - rm -rf node_modules

    # Minify the HTML code
    - npx html-minifier --input-dir . --output-dir . --collapse-boolean-attributes --collapse-inline-tag-whitespace --collapse-whitespace --decode-entities --minify-css --minify-js --minify-urls --preserve-line-breaks --remove-attribute-quotes --remove-comments --remove-redundant-attributes --remove-script-type-attributes --remove-style-link-type-attributes --use-short-doctype --file-ext html

    # Generate Sitemap
    - npx sitemap-generator-cli https://www.richie-bendall.ml

deploy:
    provider:           pages
    target_branch:      master
    local_dir:          src
    github_commit:      "CI | Built the website [skip ci]"
    skip_cleanup:       true
    github_token:       $github_token
    keep_history:       false
    fqdn:               www.richie-bendall.ml
    committer_from_gh:  true
    on:
        branch:         development

after_deploy:
   # Clear CloudFlare cache
   - |
     curl --request DELETE "https://api.cloudflare.com/client/v4/zones/${cf_zone_id}/purge_cache" \
      --header "X-Auth-Email: richiebendall@gmail.com" \
      --header "X-Auth-Key: ${cf_api_key}" \
      --header "Content-Type: application/json" \
      --data '{"purge_everything":true}'

   # Recrawl site for Google Search
   - curl https://www.google.com/ping?sitemap=https://www.richie-bendall.ml/sitemap.xml

notifications:
   # Disable emails for build status notifications
   email:              false
