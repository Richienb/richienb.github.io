# Disable sudo to speed up build
sudo:                   false

# Set the build language
language:               generic

# Set build branch
branches:               master

before_install:
  # Configure access token to enable pushing to the repository
  - git remote set-url origin https://Richienb:${github_token}@github.com/Richienb/richienb.github.io.git

  # Set commit username
  - git config --global user.name "ROS Bot"

  # Set commit email
  - git config --global user.email "richiebendall@gmail.com"

jobs:
  include:
    - stage:            Optimisation & Generating

      cache:
        # Ensure pip is cached
        - pip

      # Set the build language
      language:         python

      # Set the build language version
      python:           3.6.6

      install:
        # Install the required dependency
        - pip install pyspelling

      script:
        # Check for spelling errors
        - pyspelling

    - # Generate service worker

      # Set build language to Node JS
      language: node_js
      node_js: "node"

      cache:
          # Ensure npm is cached
          directories:
            - node_modules # NPM packages

      install:
        # Install the required dependency
        - npm install workbox-cli --global

      script:
        # Generate service worker cacher
        - npm sw

      after_script:
        # Commit and push
        - git add . && ./ci/commitpush.sh "CI | Update service worker caching configuration [skip ci]"
        
    - # Generate bundle.js

      # Set build language to Node JS
      language: node_js
      node_js: "node"

      cache:
          # Ensure npm is cached
          directories:
            - node_modules # NPM packages

      install:
        # Install the required dependencies
        - npm install workbox --save-dev
        - npm install workbox-cli --save-dev
        - npm install style-loader --save-dev

      script:
        # Generate bundle.js file
        - npm bundle

      after_script:
        # Commit and push
        - git add . && ./ci/commitpush.sh "CI | Update bundle file [skip ci]"

    - # Clear CloudFlare cache
    
      script:
        # Clear CloudFlare cache
        - |
          curl -X DELETE "https://api.cloudflare.com/client/v4/zones/${cf_zone_id}/purge_cache" \
          -H "X-Auth-Email: richiebendall@gmail.com" \
          -H "X-Auth-Key: ${cf_api_key}" \
          -H "Content-Type: application/json" \
          --data '{"purge_everything":true}'

    - stage:            Beautify code

      addons:
        apt:
          packages:
            # Install code beautifier
            - tidy

      script:
        # Perform optimisations
        - find  -type f  -name "*.html" -exec tidy -config config.txt -o "{}" "{}" \;

        # Check, commit and push
        - git add . && git diff-index --quiet HEAD || git commit -m "CI | Tidy HTML Code [skip ci]" && git push origin HEAD:master

notifications:
  # Disable emails for build status notifications
  email:                false
